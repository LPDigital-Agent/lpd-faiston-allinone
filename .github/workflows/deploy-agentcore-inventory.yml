# =============================================================================
# AgentCore Deployment Workflow - Faiston SGA Multi-Agent System
# =============================================================================
# Deploys 15 Python agents to AWS Bedrock AgentCore Runtime
# Uses Google ADK with native Gemini 3.0 Pro models
#
# Architecture:
# - 1 Orchestrator: faiston_asset_management (HTTP protocol, JWT auth)
# - 13 Specialists: faiston_sga_* (A2A protocol, SigV4 auth)
#
# Framework: Google ADK (Agent Development Kit)
# Model: All agents use gemini-3-pro-preview exclusively
# AWS Account: 377311924364 (Faiston One)
#
# Agents:
# - faiston_asset_management: Main orchestrator (receives frontend requests)
# - faiston_sga_nexo_import: Intelligent file import
# - faiston_sga_learning: Episodic memory and pattern learning
# - faiston_sga_validation: Schema and data validation
# - faiston_sga_schema_evolution: Dynamic schema evolution
# - faiston_sga_intake: NF reader (PDF/XML)
# - faiston_sga_import: Bulk import (spreadsheets, CSV)
# - faiston_sga_estoque_control: Inventory control
# - faiston_sga_compliance: Regulatory compliance
# - faiston_sga_reconciliacao: SAP reconciliation
# - faiston_sga_expedition: Shipment management
# - faiston_sga_carrier: Carrier management
# - faiston_sga_reverse: Reverse logistics
# - faiston_sga_observation: Monitoring and alerting
# - faiston_sga_equipment_research: Equipment KB
# =============================================================================

name: Deploy AgentCore Inventory

on:
  push:
    branches:
      - main
    paths:
      - 'server/agentcore-inventory/**'
      - '.github/workflows/deploy-agentcore-inventory.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - undeploy
          - status
      agent:
        description: 'Agent to deploy (leave empty for all)'
        required: false
        type: string

env:
  AWS_REGION: us-east-2
  PYTHON_VERSION: '3.11'
  # Cognito configuration for JWT Authorizer (orchestrator only)
  COGNITO_USER_POOL_ID: us-east-2_lkBXr4kjy
  COGNITO_CLIENT_ID: 7ovjm09dr94e52mpejvbu9v1cg

jobs:
  # ===========================================================================
  # Deploy All Agents (Matrix Strategy)
  # ===========================================================================
  deploy-agents:
    name: Deploy ${{ matrix.agent }}
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action != 'undeploy' && github.event.inputs.action != 'status' }}
    strategy:
      matrix:
        agent:
          # Orchestrator (HTTP protocol, JWT auth from frontend)
          - faiston_asset_management
          # Specialist agents (A2A protocol, SigV4 auth)
          - faiston_sga_nexo_import
          - faiston_sga_learning
          - faiston_sga_validation
          - faiston_sga_schema_evolution
          - faiston_sga_intake
          - faiston_sga_import
          - faiston_sga_estoque_control
          - faiston_sga_compliance
          - faiston_sga_reconciliacao
          - faiston_sga_expedition
          - faiston_sga_carrier
          - faiston_sga_reverse
          - faiston_sga_observation
          - faiston_sga_equipment_research
      max-parallel: 3  # Deploy 3 agents at a time to avoid AWS rate limits
      fail-fast: false  # Continue deploying other agents if one fails

    outputs:
      orchestrator_runtime_id: ${{ steps.get-runtime-id.outputs.runtime_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install uv and AgentCore CLI
        run: |
          # Install uv (required for direct_code_deploy)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.local/bin/env 2>/dev/null || export PATH="$HOME/.local/bin:$PATH"
          uv --version
          # Install agentcore CLI
          pip install bedrock-agentcore-starter-toolkit boto3 --quiet
          agentcore --version || echo "AgentCore CLI installed"

      - name: Deploy Agent ${{ matrix.agent }}
        working-directory: server/agentcore-inventory
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "=== Deploying ${{ matrix.agent }} ==="

          DEPLOY_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Deploy using .bedrock_agentcore.yaml configuration
          # Execution role is defined in the YAML file for each agent:
          #   execution_role: arn:aws:iam::377311924364:role/faiston-one-sga-agentcore-role
          # DO NOT pass --execution-role as CLI argument (not supported by agentcore CLI)
          echo "y" | agentcore deploy --agent ${{ matrix.agent }} \
            --auto-update-on-conflict \
            --env GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }} \
            --env INVENTORY_TABLE=faiston-one-sga-inventory-prod \
            --env HIL_TASKS_TABLE=faiston-one-sga-hil-tasks-prod \
            --env AUDIT_LOG_TABLE=faiston-one-sga-audit-log-prod \
            --env SESSIONS_TABLE=faiston-one-sga-sessions-prod \
            --env DOCUMENTS_BUCKET=faiston-one-sga-documents-prod \
            --env USE_POSTGRES_MCP=true \
            --env AGENTCORE_GATEWAY_ID=faiston-one-sga-gateway-prod-qbnlm3ao63 \
            --env AGENTCORE_GATEWAY_URL=https://faiston-one-sga-gateway-prod-qbnlm3ao63.gateway.bedrock-agentcore.us-east-2.amazonaws.com/mcp \
            --env GIT_COMMIT_SHA=${{ github.sha }} \
            --env DEPLOYED_AT=$DEPLOY_TIMESTAMP \
            --env AGENTCORE_MEMORY_ID=nexo_sga_learning_memory-u3ypElEdl1 \
            --env PROJECT_NAME=faiston-one \
            --env AGENT_ID=${{ matrix.agent }}

      - name: Check deployment status
        working-directory: server/agentcore-inventory
        run: |
          echo "=== Checking Status for ${{ matrix.agent }} ==="
          agentcore status --agent ${{ matrix.agent }} 2>&1 || true

      - name: Get Runtime ID
        id: get-runtime-id
        if: matrix.agent == 'faiston_asset_management'
        run: |
          pip install boto3 --quiet
          # Note: list_agent_runtimes() is paginated - must iterate through all pages
          RUNTIME_ID=$(python3 -c "
          import boto3
          client = boto3.client('bedrock-agentcore-control', region_name='us-east-2')
          paginator = client.get_paginator('list_agent_runtimes')
          for page in paginator.paginate():
              for rt in page.get('agentRuntimes', []):
                  if rt['agentRuntimeName'] == 'faiston_asset_management':
                      print(rt['agentRuntimeId'])
                      exit(0)
          ")
          echo "runtime_id=$RUNTIME_ID" >> $GITHUB_OUTPUT
          echo "Orchestrator Runtime ID: $RUNTIME_ID"

  # ===========================================================================
  # Configure Orchestrator JWT Authorizer
  # ===========================================================================
  # NOTE: SSM Registry update REMOVED (100% A2A Architecture)
  # Agent runtime IDs are now hardcoded in a2a_client.py - no SSM lookup needed
  # ===========================================================================
  configure-orchestrator:
    name: Configure Orchestrator JWT
    runs-on: ubuntu-latest
    needs: deploy-agents
    if: ${{ github.event.inputs.action != 'undeploy' && github.event.inputs.action != 'status' }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # =========================================================================
      # Configure JWT Authorizer for Orchestrator
      # =========================================================================
      # This runs AFTER all agents are deployed and visible in AWS API
      # Eliminates race condition that existed when JWT config was in deploy job
      # =========================================================================
      - name: Configure JWT Authorizer for Orchestrator
        run: |
          # Install boto3 with bedrock-agentcore-control support
          pip install --upgrade boto3 botocore --quiet

          # Wait for AWS API to propagate newly deployed runtimes
          # AWS AgentCore has eventual consistency delay
          echo "Waiting 60s for AWS API propagation..."
          sleep 60

          python3 << 'PYTHON_SCRIPT'
          import boto3
          import os
          import subprocess

          # NOTE: time.sleep() does NOT work in GitHub Actions Python heredocs!
          # Use subprocess.run(['sleep', 'N']) instead which calls the OS-level sleep
          def sleep_seconds(n):
              """Sleep using OS-level command - time.sleep() fails in heredocs."""
              subprocess.run(['sleep', str(n)], check=True)

          REGION = "us-east-2"
          COGNITO_POOL_ID = os.environ.get("COGNITO_USER_POOL_ID")
          COGNITO_CLIENT_ID = os.environ.get("COGNITO_CLIENT_ID")
          # Retry settings - increased for eventual consistency
          MAX_FIND_RETRIES = 15
          FIND_RETRY_DELAY = 20

          print("=== Configuring JWT Authorizer for Orchestrator ===", flush=True)
          print(f"  Cognito Pool: {COGNITO_POOL_ID}", flush=True)
          print(f"  Cognito Client: {COGNITO_CLIENT_ID}", flush=True)

          client = boto3.client("bedrock-agentcore-control", region_name=REGION)

          # Helper function to list ALL agent runtimes with pagination
          # CRITICAL: The list_agent_runtimes() API is paginated!
          def list_all_runtimes():
              """Fetch all agent runtimes using pagination."""
              all_runtimes = []
              paginator = client.get_paginator("list_agent_runtimes")
              for page in paginator.paginate():
                  all_runtimes.extend(page.get("agentRuntimes", []))
              return all_runtimes

          # Find orchestrator runtime with retry for API eventual consistency
          # Retry here handles AWS API eventual consistency
          agent_runtime_id = None
          all_runtimes = []
          for find_attempt in range(MAX_FIND_RETRIES):
              all_runtimes = list_all_runtimes()
              for rt in all_runtimes:
                  if rt["agentRuntimeName"] == "faiston_asset_management":
                      agent_runtime_id = rt["agentRuntimeId"]
                      print(f"  Found orchestrator runtime: {agent_runtime_id}", flush=True)
                      break
              if agent_runtime_id:
                  break
              print(f"  Orchestrator not found, retrying... (attempt {find_attempt + 1}/{MAX_FIND_RETRIES})", flush=True)
              sleep_seconds(FIND_RETRY_DELAY)

          if not agent_runtime_id:
              print("ERROR: Orchestrator runtime not found after retries!", flush=True)
              print("  Available runtimes:", flush=True)
              for rt in all_runtimes:
                  print(f"    - {rt['agentRuntimeName']}: {rt['agentRuntimeId']}", flush=True)
              exit(1)

          # Wait for READY status (per AWS docs: CREATING â†’ READY)
          # NOTE: AgentCore uses "READY" NOT "ACTIVE" as the final successful state!
          # Valid statuses: CREATING, CREATE_FAILED, UPDATING, UPDATE_FAILED, READY, DELETING
          MAX_RETRIES = 10
          RETRY_DELAY = 6
          current_config = None

          for attempt in range(MAX_RETRIES):
              try:
                  current_config = client.get_agent_runtime(agentRuntimeId=agent_runtime_id)
                  status = current_config.get("status")
                  print(f"  Current status: {status}", flush=True)
                  if status == "READY":
                      print("  âœ… Runtime is READY!", flush=True)
                      break
                  if status in ("CREATE_FAILED", "UPDATE_FAILED"):
                      print(f"  âŒ Runtime in failed state: {status}", flush=True)
                      exit(1)
                  print(f"  Waiting for READY state... (attempt {attempt + 1}/{MAX_RETRIES})", flush=True)
                  sleep_seconds(RETRY_DELAY)
              except Exception as e:
                  print(f"  Waiting... {e}", flush=True)
                  sleep_seconds(RETRY_DELAY)

          if not current_config or current_config.get("status") != "READY":
              print("ERROR: Runtime did not reach READY status!")
              exit(1)

          # Check if JWT already configured
          existing_auth = current_config.get("authorizerConfiguration", {})
          existing_jwt = existing_auth.get("customJWTAuthorizer", {})
          if existing_jwt:
              existing_clients = existing_jwt.get("allowedClients", [])
              print(f"  Existing allowedClients: {existing_clients}")
              if COGNITO_CLIENT_ID in existing_clients:
                  print("  âœ… JWT Authorizer already configured - skipping")
                  exit(0)

          # Build update payload
          discovery_url = f"https://cognito-idp.{REGION}.amazonaws.com/{COGNITO_POOL_ID}/.well-known/openid-configuration"

          update_params = {
              "agentRuntimeId": agent_runtime_id,
              "agentRuntimeArtifact": current_config.get("agentRuntimeArtifact"),
              "networkConfiguration": current_config.get("networkConfiguration"),
              "roleArn": current_config.get("roleArn"),
              "authorizerConfiguration": {
                  "customJWTAuthorizer": {
                      "discoveryUrl": discovery_url,
                      "allowedClients": [COGNITO_CLIENT_ID]
                  }
              }
          }

          # Preserve optional configurations
          if current_config.get("protocolConfiguration"):
              update_params["protocolConfiguration"] = current_config["protocolConfiguration"]
          if current_config.get("environmentVariables"):
              update_params["environmentVariables"] = current_config["environmentVariables"]
          if current_config.get("description"):
              update_params["description"] = current_config["description"]

          try:
              client.update_agent_runtime(**update_params)
              print("âœ… JWT Authorizer configured successfully!")
              print(f"  Discovery URL: {discovery_url}")
          except client.exceptions.ConflictException:
              print("âœ… JWT Authorizer already configured - skipping")
          except Exception as e:
              print(f"ERROR: Failed to update runtime: {e}")
              exit(1)
          PYTHON_SCRIPT

  # ===========================================================================
  # Deployment Summary
  # ===========================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-agents, configure-orchestrator]
    if: always() && github.event.inputs.action != 'undeploy' && github.event.inputs.action != 'status'

    steps:
      - name: Generate Summary
        run: |
          echo "## AgentCore Multi-Agent Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architecture" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Framework | Google ADK (native Gemini) |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | gemini-3-pro-preview |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`us-east-2\` |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Account | \`377311924364\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agents Deployed (15)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Orchestrator (HTTP/JWT):**" >> $GITHUB_STEP_SUMMARY
          echo "- \`faiston_asset_management\` - Main entry point for frontend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Specialist Agents (A2A/SigV4):**" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| nexo_import | Intelligent file import |" >> $GITHUB_STEP_SUMMARY
          echo "| learning | Episodic memory |" >> $GITHUB_STEP_SUMMARY
          echo "| validation | Schema validation |" >> $GITHUB_STEP_SUMMARY
          echo "| schema_evolution | Dynamic schema |" >> $GITHUB_STEP_SUMMARY
          echo "| intake | NF reader (PDF/XML) |" >> $GITHUB_STEP_SUMMARY
          echo "| import | Bulk import |" >> $GITHUB_STEP_SUMMARY
          echo "| estoque_control | Inventory control |" >> $GITHUB_STEP_SUMMARY
          echo "| compliance | Regulatory compliance |" >> $GITHUB_STEP_SUMMARY
          echo "| reconciliacao | SAP reconciliation |" >> $GITHUB_STEP_SUMMARY
          echo "| expedition | Shipment management |" >> $GITHUB_STEP_SUMMARY
          echo "| carrier | Carrier tracking |" >> $GITHUB_STEP_SUMMARY
          echo "| reverse | Reverse logistics |" >> $GITHUB_STEP_SUMMARY
          echo "| observation | Monitoring |" >> $GITHUB_STEP_SUMMARY
          echo "| equipment_research | Equipment KB |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Authentication" >> $GITHUB_STEP_SUMMARY
          echo "| Protocol | Auth Method |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend â†’ Orchestrator | JWT Bearer Token (Cognito) |" >> $GITHUB_STEP_SUMMARY
          echo "| Orchestrator â†’ Agents | SigV4 (IAM) via A2A |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agent Discovery (100% A2A)" >> $GITHUB_STEP_SUMMARY
          echo "Runtime IDs are hardcoded in \`a2a_client.py\` (NO SSM lookups)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Undeploy All Agents
  # ===========================================================================
  undeploy:
    name: Undeploy All Agents
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'undeploy' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install AgentCore CLI
        run: |
          pip install bedrock-agentcore-starter-toolkit --quiet

      - name: Undeploy all agents
        working-directory: server/agentcore-inventory
        run: |
          AGENTS=(
            faiston_asset_management
            faiston_sga_nexo_import
            faiston_sga_learning
            faiston_sga_validation
            faiston_sga_schema_evolution
            faiston_sga_intake
            faiston_sga_import
            faiston_sga_estoque_control
            faiston_sga_compliance
            faiston_sga_reconciliacao
            faiston_sga_expedition
            faiston_sga_carrier
            faiston_sga_reverse
            faiston_sga_observation
            faiston_sga_equipment_research
          )

          for agent in "${AGENTS[@]}"; do
            echo "=== Undeploying $agent ==="
            echo "y" | agentcore destroy --agent "$agent" 2>&1 || {
              echo "::warning::Destroy returned non-zero for $agent"
            }
          done

      - name: Undeploy Summary
        run: |
          echo "## AgentCore Inventory Undeployed ðŸ”´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All 15 agents have been undeployed from AgentCore Runtime." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Check Status
  # ===========================================================================
  status:
    name: Check AgentCore Status
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'status' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          pip install bedrock-agentcore-starter-toolkit boto3 --quiet

      - name: Check all agent status
        run: |
          python3 << 'PYTHON_SCRIPT'
          import boto3

          client = boto3.client("bedrock-agentcore-control", region_name="us-east-2")

          # Use paginator to list ALL runtimes (API is paginated!)
          all_runtimes = []
          paginator = client.get_paginator("list_agent_runtimes")
          for page in paginator.paginate():
              all_runtimes.extend(page.get("agentRuntimes", []))

          print("=== AgentCore Runtime Status ===\n")

          our_agents = []
          for rt in all_runtimes:
              name = rt["agentRuntimeName"]
              if name.startswith("faiston"):
                  our_agents.append(rt)

          if not our_agents:
              print("No Faiston agents found.")
          else:
              print(f"{'Agent Name':<40} {'Status':<15} {'Runtime ID'}")
              print("-" * 80)
              for rt in sorted(our_agents, key=lambda x: x['agentRuntimeName']):
                  print(f"{rt['agentRuntimeName']:<40} {rt.get('status', 'UNKNOWN'):<15} {rt['agentRuntimeId']}")
              print()
              print(f"Total Faiston agents: {len(our_agents)}")
          PYTHON_SCRIPT

      - name: Status Summary
        run: |
          echo "## AgentCore Status ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed agent status." >> $GITHUB_STEP_SUMMARY
