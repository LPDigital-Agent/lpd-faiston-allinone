# =============================================================================
# AgentCore Deployment Workflow - Faiston SGA Inventory (GestÃ£o de Estoque)
# =============================================================================
# Deploys Python agents to AWS Bedrock AgentCore Runtime
# Uses Google ADK with native Gemini 3.0 Pro models
#
# Framework: Google ADK (Agent Development Kit)
# Model: All agents use gemini-3-pro-preview exclusively
# AWS Account: 377311924364 (Faiston One)
#
# Agents:
# - EstoqueControlAgent: Core +/- inventory movements
# - IntakeAgent: NF reading (PDF/XML extraction)
# - ReconciliacaoAgent: Divergence detection and inventory counts
# - ComplianceAgent: Policy validation and approval workflows
# - ComunicacaoAgent: Notifications and technician communication
# =============================================================================

name: Deploy AgentCore Inventory

on:
  push:
    branches:
      - main
    paths:
      - 'server/agentcore-inventory/**'
      - '.github/workflows/deploy-agentcore-inventory.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - undeploy
          - status

env:
  AWS_REGION: us-east-2
  PYTHON_VERSION: '3.11'
  AGENT_NAME: faiston_asset_management

jobs:
  deploy:
    name: Deploy to AgentCore Runtime
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action != 'undeploy' && github.event.inputs.action != 'status' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install uv and AgentCore CLI
        run: |
          # Install uv (required for direct_code_deploy)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.local/bin/env 2>/dev/null || export PATH="$HOME/.local/bin:$PATH"
          uv --version
          # Install agentcore CLI
          pip install bedrock-agentcore-starter-toolkit --quiet
          agentcore --version || echo "AgentCore CLI installed"

      - name: Update AgentCore config for CI/CD
        working-directory: server/agentcore-inventory
        run: |
          # Update paths in config to use CI/CD workspace
          # Use Terraform-managed IAM role with S3, DynamoDB, SSM permissions
          # See: terraform/main/iam_sga_agentcore.tf
          cat > .bedrock_agentcore.yaml << 'EOF'
          default_agent: faiston_asset_management
          agents:
            faiston_asset_management:
              name: faiston_asset_management
              entrypoint: main.py
              deployment_type: direct_code_deploy
              runtime_type: PYTHON_3_11
              platform: linux/arm64
              container_runtime: null
              source_path: .
              aws:
                account: '377311924364'
                region: us-east-2
                execution_role: arn:aws:iam::377311924364:role/faiston-one-sga-agentcore-role
                network_configuration:
                  network_mode: PUBLIC
                  network_mode_config: null
                protocol_configuration:
                  server_protocol: HTTP
                observability:
                  enabled: true
                lifecycle_configuration:
                  idle_runtime_session_timeout: null
                  max_lifetime: null
              memory:
                mode: STM_AND_LTM
                memory_id: nexo_agent_mem-Z5uQr8CDGf
          EOF

      - name: Show agent files
        working-directory: server/agentcore-inventory
        run: |
          echo "=== Agent Files ==="
          find . -name "*.py" -type f | head -30
          echo ""
          echo "=== Config ==="
          cat .bedrock_agentcore.yaml

      - name: Deploy to AgentCore Runtime
        working-directory: server/agentcore-inventory
        run: |
          # Ensure uv is in PATH
          export PATH="$HOME/.local/bin:$PATH"
          echo "=== Deploying AgentCore Agent ==="
          # Environment variables for agents
          # PostgreSQL MCP Gateway (Sprint 4 migration - currently disabled)
          # Set USE_POSTGRES_MCP=true to enable PostgreSQL via Gateway
          # GIT_COMMIT_SHA and DEPLOYED_AT for version tracking in health_check
          DEPLOY_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "y" | agentcore deploy --agent ${{ env.AGENT_NAME }} \
            --auto-update-on-conflict \
            --env GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }} \
            --env INVENTORY_TABLE=faiston-one-sga-inventory-prod \
            --env HIL_TASKS_TABLE=faiston-one-sga-hil-tasks-prod \
            --env AUDIT_LOG_TABLE=faiston-one-sga-audit-log-prod \
            --env DOCUMENTS_BUCKET=faiston-one-sga-documents-prod \
            --env USE_POSTGRES_MCP=true \
            --env AGENTCORE_GATEWAY_ID=faiston-one-sga-gateway-prod-qbnlm3ao63 \
            --env AGENTCORE_GATEWAY_URL=https://faiston-one-sga-gateway-prod-qbnlm3ao63.gateway.bedrock-agentcore.us-east-2.amazonaws.com/mcp \
            --env GIT_COMMIT_SHA=${{ github.sha }} \
            --env DEPLOYED_AT=$DEPLOY_TIMESTAMP \
            --env AGENTCORE_MEMORY_ID=nexo_agent_mem-Z5uQr8CDGf 2>&1 || {
            echo "::warning::Deploy command returned non-zero exit code. Checking status..."
          }

      - name: Check deployment status
        working-directory: server/agentcore-inventory
        run: |
          echo "=== Checking AgentCore Status ==="
          agentcore status --agent ${{ env.AGENT_NAME }} 2>&1 || true

      # =========================================================================
      # Configure JWT Authorizer for Cognito Authentication
      # =========================================================================
      # The agentcore CLI does NOT apply authorizerConfiguration from YAML.
      # We must call UpdateAgentRuntime API directly to enable JWT Bearer token
      # authentication from the frontend.
      # =========================================================================
      - name: Configure JWT Authorizer
        env:
          # Faiston One Cognito - HARDCODED to ensure consistency
          # These are NOT secrets - they appear in frontend JS and JWT tokens
          # faiston-users-prod / faiston-client-prod
          COGNITO_USER_POOL_ID: us-east-2_lkBXr4kjy
          COGNITO_CLIENT_ID: 7ovjm09dr94e52mpejvbu9v1cg
          # Known runtime ID from successful deployment
          AGENT_RUNTIME_ID: faiston_asset_management-uSuLPsFQNH
        run: |
          pip install boto3 --quiet
          python3 << 'PYTHON_SCRIPT'
          import boto3
          import os

          REGION = "us-east-2"
          COGNITO_POOL_ID = os.environ.get("COGNITO_USER_POOL_ID")
          COGNITO_CLIENT_ID = os.environ.get("COGNITO_CLIENT_ID")
          # Use known runtime ID directly (avoids name lookup issues)
          agent_runtime_id = os.environ.get("AGENT_RUNTIME_ID")

          print(f"Configuring JWT Authorizer for runtime: {agent_runtime_id}")
          print(f"  Cognito Pool: {COGNITO_POOL_ID}")
          print(f"  Cognito Client: {COGNITO_CLIENT_ID}")

          # Use boto3 client which handles SigV4 signing automatically
          client = boto3.client("bedrock-agentcore-control", region_name=REGION)

          print(f"  Runtime ID: {agent_runtime_id}")

          # Step 1: Get current runtime configuration
          try:
              current_config = client.get_agent_runtime(agentRuntimeId=agent_runtime_id)
              print(f"  Current status: {current_config.get('status')}")
          except Exception as e:
              print(f"ERROR: Failed to get runtime config: {e}")
              exit(1)

          # Check current authorizer config
          existing_auth = current_config.get("authorizerConfiguration", {})
          existing_jwt = existing_auth.get("customJWTAuthorizer", {})
          if existing_jwt:
              existing_clients = existing_jwt.get("allowedClients", [])
              print(f"  Existing allowedClients: {existing_clients}")
              if COGNITO_CLIENT_ID in existing_clients:
                  print("  âœ… JWT Authorizer already has correct client ID - skipping update")
                  exit(0)
              else:
                  print("  âš ï¸  Updating JWT Authorizer with correct client ID...")

          # Step 2: Build update payload with JWT authorizer
          discovery_url = f"https://cognito-idp.{REGION}.amazonaws.com/{COGNITO_POOL_ID}/.well-known/openid-configuration"

          # IMPORTANT: Cognito Access Tokens have "client_id" claim, NOT "aud" claim
          # The "aud" claim only exists if a Resource Server binding is configured.
          # We use allowedClients to validate "client_id" and omit allowedAudiences.
          update_params = {
              "agentRuntimeId": agent_runtime_id,
              "agentRuntimeArtifact": current_config.get("agentRuntimeArtifact"),
              "networkConfiguration": current_config.get("networkConfiguration"),
              "roleArn": current_config.get("roleArn"),
              "authorizerConfiguration": {
                  "customJWTAuthorizer": {
                      "discoveryUrl": discovery_url,
                      "allowedClients": [COGNITO_CLIENT_ID]
                  }
              }
          }

          # Preserve optional configurations
          if current_config.get("protocolConfiguration"):
              update_params["protocolConfiguration"] = current_config["protocolConfiguration"]
          if current_config.get("environmentVariables"):
              update_params["environmentVariables"] = current_config["environmentVariables"]
          if current_config.get("description"):
              update_params["description"] = current_config["description"]

          # Step 3: Update runtime with JWT authorizer
          try:
              client.update_agent_runtime(**update_params)
              print("âœ… JWT Authorizer configured successfully!")
              print(f"  Discovery URL: {discovery_url}")
          except client.exceptions.ConflictException:
              print("âœ… JWT Authorizer already configured - skipping")
              print(f"  Discovery URL: {discovery_url}")
          except Exception as e:
              print(f"ERROR: Failed to update runtime: {e}")
              exit(1)
          PYTHON_SCRIPT

      - name: Health check
        working-directory: server/agentcore-inventory
        continue-on-error: true
        run: |
          echo "=== Running Health Check ==="
          # Simple invoke test
          agentcore invoke --agent ${{ env.AGENT_NAME }} '{"action": "health_check"}' 2>&1 || {
            echo "::warning::Health check invoke failed (may need custom health action)"
          }

      - name: Deployment Summary
        run: |
          echo "## AgentCore Inventory Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Agent Name | \`${{ env.AGENT_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Framework | Google ADK (native Gemini) |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | gemini-3-pro-preview |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Account | \`377311924364\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Auth** | **Cognito JWT Bearer Token** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Authentication:**" >> $GITHUB_STEP_SUMMARY
          echo "| Config | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| User Pool | \`us-east-2_lkBXr4kjy\` (faiston-users-prod) |" >> $GITHUB_STEP_SUMMARY
          echo "| Client ID | \`7ovjm09dr94e52mpejvbu9v1cg\` (faiston-client-prod) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PostgreSQL MCP Gateway (ENABLED):**" >> $GITHUB_STEP_SUMMARY
          echo "| Config | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway ID | \`faiston-one-sga-gateway-prod-qbnlm3ao63\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Name | \`SGAPostgresTools\` |" >> $GITHUB_STEP_SUMMARY
          echo "| USE_POSTGRES_MCP | \`true\` (schema queries via MCP Gateway) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**5 AI Agents:**" >> $GITHUB_STEP_SUMMARY
          echo "- EstoqueControlAgent - Core inventory movements" >> $GITHUB_STEP_SUMMARY
          echo "- IntakeAgent - NF PDF/XML extraction" >> $GITHUB_STEP_SUMMARY
          echo "- ReconciliacaoAgent - Divergence detection" >> $GITHUB_STEP_SUMMARY
          echo "- ComplianceAgent - Policy validation" >> $GITHUB_STEP_SUMMARY
          echo "- ComunicacaoAgent - Notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Actions:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`health_check\` - System health" >> $GITHUB_STEP_SUMMARY
          echo "- \`search_assets\` - Asset search" >> $GITHUB_STEP_SUMMARY
          echo "- \`where_is_serial\` - Serial lookup" >> $GITHUB_STEP_SUMMARY
          echo "- \`get_balance\` - Balance queries" >> $GITHUB_STEP_SUMMARY
          echo "- \`process_nf_upload\` - NF processing" >> $GITHUB_STEP_SUMMARY
          echo "- \`create_movement\` - Inventory movements" >> $GITHUB_STEP_SUMMARY
          echo "- \`start_inventory_count\` - Counting campaigns" >> $GITHUB_STEP_SUMMARY
          echo "- \`chat\` - NEXO Estoque assistant" >> $GITHUB_STEP_SUMMARY

  undeploy:
    name: Undeploy AgentCore Agent
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'undeploy' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install AgentCore CLI
        run: |
          pip install bedrock-agentcore-starter-toolkit --quiet

      - name: Undeploy agent
        working-directory: server/agentcore-inventory
        run: |
          echo "=== Destroying AgentCore Agent ==="
          echo "y" | agentcore destroy --agent ${{ env.AGENT_NAME }} 2>&1 || {
            echo "::warning::Destroy returned non-zero exit code"
          }

      - name: Undeploy Summary
        run: |
          echo "## AgentCore Inventory Undeployed ðŸ”´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Agent \`${{ env.AGENT_NAME }}\` has been undeployed from AgentCore Runtime." >> $GITHUB_STEP_SUMMARY

  status:
    name: Check AgentCore Status
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'status' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install AgentCore CLI
        run: |
          pip install bedrock-agentcore-starter-toolkit --quiet

      - name: Check status
        working-directory: server/agentcore-inventory
        run: |
          echo "=== AgentCore Agent Status ==="
          agentcore status --agent ${{ env.AGENT_NAME }} 2>&1 || true

      - name: Status Summary
        run: |
          echo "## AgentCore Inventory Status ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for agent status details." >> $GITHUB_STEP_SUMMARY
