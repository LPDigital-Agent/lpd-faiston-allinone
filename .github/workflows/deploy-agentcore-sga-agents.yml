# =============================================================================
# AgentCore Deployment Workflow - 14 SGA Agents (TRUE Multi-Agent A2A)
# =============================================================================
# Deploys all 14 SGA agents to their dedicated AgentCore Runtimes.
# Each agent runs in its own runtime with A2A communication.
#
# Architecture (100% TRUE Multi-Agent A2A):
# - 14 separate AgentCore Runtimes (one per agent)
# - A2A Protocol (JSON-RPC 2.0, port 9000, root path /)
# - AWS Strands Agents framework with A2AServer
# - Each agent has its OWN main.py with Strands A2AServer
# - ORCHESTRATOR (nexo_import) routes to SPECIALISTS via A2A
# - ReAct Pattern: OBSERVEâ†’THINKâ†’LEARNâ†’EXECUTE + HIL
#
# MIGRATION COMPLETE: BedrockAgentCoreApp (HTTP) â†’ Strands A2AServer (A2A)
# - Each agent has: agents/<agent_id>/main.py (own A2AServer)
# - Entry point: main.py at package root (copied from agent's main.py)
# - NO unified main_a2a.py - TRUE multi-agent isolation
#
# Deployment Strategy:
# 1. Package each agent's OWN main.py with shared modules
# 2. Upload ZIP artifacts to S3
# 3. Terraform manages the runtimes (A2A protocol)
#
# Reference: terraform/main/agentcore_runtimes.tf
# =============================================================================

name: Deploy SGA Agents (14 Runtimes)

on:
  push:
    branches:
      - main
    paths:
      # Each agent has its own main.py (TRUE Multi-Agent A2A)
      - 'server/agentcore-inventory/agents/*/main.py'
      - 'server/agentcore-inventory/agents/**'
      - 'server/agentcore-inventory/shared/**'
      - 'server/agentcore-inventory/tools/**'
      - '.github/workflows/deploy-agentcore-sga-agents.yml'
  workflow_dispatch:
    inputs:
      agents:
        description: 'Agents to deploy (comma-separated or "all")'
        required: false
        default: 'all'
        type: string
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - validate
          - status

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: '377311924364'
  PYTHON_VERSION: '3.13'
  S3_BUCKET: faiston-one-sga-documents-prod
  S3_PREFIX: agentcore/agents

jobs:
  # ===========================================================================
  # Job 1: Validate Agent Structure
  # ===========================================================================
  validate:
    name: Validate Agents
    runs-on: ubuntu-latest

    outputs:
      agents_to_deploy: ${{ steps.detect.outputs.agents }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run validation script
        working-directory: server/agentcore-inventory
        run: |
          python scripts/validate_agents.py
          if [ $? -ne 0 ]; then
            echo "::error::Agent validation failed"
            exit 1
          fi

      - name: Detect agents to deploy
        id: detect
        run: |
          if [ "${{ github.event.inputs.agents }}" = "all" ] || [ -z "${{ github.event.inputs.agents }}" ]; then
            # NOTE: "data_import" renamed from "import" (Python reserved keyword)
            AGENTS="learning,validation,schema_evolution,nexo_import,intake,data_import,estoque_control,compliance,reconciliacao,expedition,carrier,reverse,observation,equipment_research"
          else
            AGENTS="${{ github.event.inputs.agents }}"
          fi
          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "Agents to deploy: $AGENTS"

  # ===========================================================================
  # Job 2: Package and Upload Agents
  # ===========================================================================
  package:
    name: Package ${{ matrix.agent }}
    # Using x86_64 runner with cross-compilation for ARM64
    # AgentCore Runtime uses AWS Graviton (ARM64), so we must download ARM64 wheels
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.event.inputs.action != 'status' }}

    strategy:
      fail-fast: false
      matrix:
        # NOTE: "data_import" renamed from "import" (Python reserved keyword)
        agent:
          - learning
          - validation
          - schema_evolution
          - nexo_import
          - intake
          - data_import
          - estoque_control
          - compliance
          - reconciliacao
          - expedition
          - carrier
          - reverse
          - observation
          - equipment_research

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python and uv
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Package agent (ARM64 cross-compile)
        working-directory: server/agentcore-inventory
        run: |
          AGENT="${{ matrix.agent }}"
          echo "=== Packaging $AGENT for ARM64 (Graviton) ==="

          # Create package directory
          PACKAGE_DIR="dist/$AGENT"
          mkdir -p "$PACKAGE_DIR"

          # =========================================================================
          # Copy agent code with PRESERVED DIRECTORY STRUCTURE
          # =========================================================================
          # AgentCore Runtime entry point: main.py at package root
          # TRUE Multi-Agent A2A: Each agent has its OWN main.py with A2AServer
          # - Each agent is ISOLATED with its own Strands A2AServer
          # - Strands A2AServer serves at port 9000, root path /
          # - ORCHESTRATOR (nexo_import) routes to SPECIALISTS via A2A
          #
          # Structure:
          #   main.py (copied from agents/<agent_id>/main.py)  <- Entry point
          #   agents/
          #     <agent_id>/
          #       agent.py (business logic)
          #       tools/
          #     utils.py (model config)
          #   shared/
          #     a2a_client.py (inter-agent communication)
          # =========================================================================

          # Copy agent's OWN main.py to package root (TRUE Multi-Agent A2A)
          # Each agent has its own Strands A2AServer entry point
          if [ -f "agents/$AGENT/main.py" ]; then
            cp "agents/$AGENT/main.py" "$PACKAGE_DIR/main.py"
            echo "âœ… Copied agents/$AGENT/main.py â†’ main.py"
          else
            echo "::error::Missing agents/$AGENT/main.py - TRUE Multi-Agent A2A requires per-agent main.py"
            exit 1
          fi

          # Copy agent modules (agent's own directory + utils.py for model config)
          # TRUE Multi-Agent: Each agent has isolated business logic
          mkdir -p "$PACKAGE_DIR/agents/$AGENT"
          cp -r agents/$AGENT/* "$PACKAGE_DIR/agents/$AGENT/"

          # Copy utils.py for centralized model configuration (Gemini 3.0)
          if [ -f "agents/utils.py" ]; then
            cp "agents/utils.py" "$PACKAGE_DIR/agents/utils.py"
          fi

          # Create agents/__init__.py
          touch "$PACKAGE_DIR/agents/__init__.py"

          # Copy tools/ directory (contains MCP clients, adapters, etc.)
          if [ -d "tools" ]; then
            mkdir -p "$PACKAGE_DIR/tools"
            cp -r tools/* "$PACKAGE_DIR/tools/"
            touch "$PACKAGE_DIR/tools/__init__.py"
          fi

          # Copy shared modules
          mkdir -p "$PACKAGE_DIR/shared"
          cp -r shared/* "$PACKAGE_DIR/shared/"
          # Ensure shared/__init__.py exists for proper package
          touch "$PACKAGE_DIR/shared/__init__.py"

          # Copy requirements.txt to package root (if exists in agent folder)
          if [ -f "agents/$AGENT/requirements.txt" ]; then
            cp "agents/$AGENT/requirements.txt" "$PACKAGE_DIR/requirements.txt"
          fi

          # Ensure requirements.txt exists with Strands A2A dependencies
          # NOTE: boto3, botocore, httpx, anyio, pydantic are PRE-INSTALLED on AgentCore Runtime
          if [ ! -f "$PACKAGE_DIR/requirements.txt" ]; then
            echo "Creating default requirements.txt (Strands A2A)"
            cat > "$PACKAGE_DIR/requirements.txt" << 'EOF'
          # Core framework - AWS Strands A2A (REQUIRED)
          strands-agents[a2a]>=0.1.0
          bedrock-agentcore>=0.1.0
          strands-agents-tools>=0.1.0
          # A2A Server dependencies
          uvicorn>=0.30.0
          fastapi>=0.115.0
          # Google Gemini for LLM (used by Strands Agent)
          google-genai>=1.0.0
          # MCP Protocol for AgentCore Gateway communication
          mcp>=0.1.0
          # PostgreSQL driver for Lambda MCP Tools
          psycopg[binary]>=3.1.0
          # Excel parsing
          openpyxl>=3.1.0
          xlrd>=2.0.1
          EOF
          fi

          # =========================================================================
          # AgentCore Runtime Best Practices for ZIP Deployment
          # =========================================================================
          # Runtime: AWS Graviton (ARM64) + Amazon Linux 2023
          # Platform: linux_aarch64 / manylinux2014_aarch64
          # Size limit: 250 MB zipped, 750 MB unzipped
          #
          # IMPORTANT: AgentCore Runtime â‰  Lambda!
          # Lambda has boto3/botocore pre-installed, AgentCore does NOT.
          # We MUST include boto3/botocore in our ZIP.
          #
          # Strategy:
          #   1. Install google-adk (transitive deps don't include boto3)
          #   2. Install aws-xray-sdk with --no-deps (add botocore separately)
          #   3. Install bedrock-agentcore with --no-deps (add boto3 separately)
          #   4. Install boto3, botocore, and other required deps manually
          # =========================================================================
          echo "Installing ARM64 dependencies using uv (multi-step to exclude pre-installed)..."

          # Common uv flags for ARM64 cross-compilation
          UV_FLAGS="--python-platform aarch64-manylinux2014 --python-version 3.13 --target $PACKAGE_DIR --only-binary=:all:"

          # Step 1: Install strands-agents[a2a,gemini] (AWS Strands A2A framework + Gemini model)
          # CRITICAL: The 'gemini' extra installs google-genai, required for GeminiModel
          # Without it, agents crash with: ImportError: cannot import name 'genai' from 'google'
          echo "Step 1: Installing strands-agents[a2a,gemini]..."
          $HOME/.local/bin/uv pip install $UV_FLAGS "strands-agents[a2a,gemini]"

          # Step 2: Install bedrock-agentcore WITHOUT its dependencies
          # (we install boto3/botocore separately in Step 4 for ARM64 compatibility)
          echo "Step 2: Installing bedrock-agentcore (--no-deps)..."
          $HOME/.local/bin/uv pip install $UV_FLAGS --no-deps bedrock-agentcore

          # Step 3: Install uvicorn and fastapi for A2A server
          echo "Step 3: Installing uvicorn, fastapi..."
          $HOME/.local/bin/uv pip install $UV_FLAGS uvicorn fastapi

          # Step 4: Install required dependencies (AgentCore â‰  Lambda!)
          # AgentCore Runtime does NOT have boto3/botocore pre-installed.
          # strands-agents requires: boto3, botocore, starlette, uvicorn, websockets
          echo "Step 4: Installing required deps (including boto3/botocore)..."
          $HOME/.local/bin/uv pip install $UV_FLAGS boto3 botocore wrapt starlette typing-extensions urllib3 websockets

          # Step 5: Install any agent-specific dependencies from requirements.txt
          # (Skip known packages we already installed)
          echo "Step 5: Installing agent-specific dependencies..."
          if [ -f "$PACKAGE_DIR/requirements.txt" ]; then
            # Filter out packages we already installed or are pre-installed
            grep -v -E "^(bedrock-agentcore|google-adk|aws-xray-sdk|boto3|botocore|httpx|anyio|pydantic|requests|tenacity|wrapt|starlette|uvicorn|websockets)" \
              "$PACKAGE_DIR/requirements.txt" > "$PACKAGE_DIR/requirements-filtered.txt" || true
            if [ -s "$PACKAGE_DIR/requirements-filtered.txt" ]; then
              echo "Installing additional packages:"
              cat "$PACKAGE_DIR/requirements-filtered.txt"
              $HOME/.local/bin/uv pip install $UV_FLAGS -r "$PACKAGE_DIR/requirements-filtered.txt"
            fi
            rm -f "$PACKAGE_DIR/requirements-filtered.txt"
          fi

          echo "Dependencies installed for ARM64"
          echo "Package contents:"
          ls -la "$PACKAGE_DIR" | head -30
          echo ""
          echo "Verifying boto3/botocore included (required for AgentCore):"
          ls -d "$PACKAGE_DIR/boto"* 2>/dev/null && echo "âœ… boto3/botocore present" || echo "âŒ ERROR: boto3/botocore NOT in package!"

          # =========================================================================
          # Set POSIX permissions (required by AgentCore Runtime)
          # - Files: 644 (rw-r--r--)
          # - Directories: 755 (rwxr-xr-x)
          # =========================================================================
          echo "Setting POSIX permissions..."
          find "$PACKAGE_DIR" -type f -exec chmod 644 {} \;
          find "$PACKAGE_DIR" -type d -exec chmod 755 {} \;

          # =========================================================================
          # Create ZIP with flat structure
          # - main.py at root of ZIP (not in subfolder)
          # - Exclude __pycache__ and .pyc (bytecode from wrong arch may crash)
          # - Include .dist-info (required for entry point discovery)
          # =========================================================================
          cd "dist/$AGENT"
          zip -r "../$AGENT.zip" . -x "*.pyc" -x "__pycache__/*" -x "*/__pycache__/*"
          cd ../..

          echo "Package created: dist/$AGENT.zip"
          ls -lah "dist/$AGENT.zip"
          ZIP_SIZE=$(du -h "dist/$AGENT.zip" | cut -f1)
          echo "Package size: $ZIP_SIZE"

          # Verify size is under 250 MB limit
          ZIP_BYTES=$(stat -f%z "dist/$AGENT.zip" 2>/dev/null || stat -c%s "dist/$AGENT.zip")
          MAX_BYTES=$((250 * 1024 * 1024))
          if [ "$ZIP_BYTES" -gt "$MAX_BYTES" ]; then
            echo "::error::ZIP exceeds 250 MB limit! Use Container Image deployment."
            exit 1
          fi

      - name: Upload to S3
        working-directory: server/agentcore-inventory
        run: |
          AGENT="${{ matrix.agent }}"
          S3_KEY="${{ env.S3_PREFIX }}/$AGENT/agent.zip"

          echo "=== Uploading $AGENT to S3 ==="
          echo "Bucket: ${{ env.S3_BUCKET }}"
          echo "Key: $S3_KEY"

          aws s3 cp "dist/$AGENT.zip" "s3://${{ env.S3_BUCKET }}/$S3_KEY" \
            --metadata "agent=$AGENT,commit=${{ github.sha }},deployed_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          echo "âœ… Uploaded successfully"

      - name: Verify upload
        run: |
          AGENT="${{ matrix.agent }}"
          S3_KEY="${{ env.S3_PREFIX }}/$AGENT/agent.zip"

          aws s3 ls "s3://${{ env.S3_BUCKET }}/$S3_KEY" || {
            echo "::error::Failed to verify upload for $AGENT"
            exit 1
          }

  # ===========================================================================
  # Job 3: Update Runtimes
  # ===========================================================================
  update-runtimes:
    name: Update AgentCore Runtimes
    runs-on: ubuntu-latest
    needs: package
    if: ${{ github.event.inputs.action != 'validate' && github.event.inputs.action != 'status' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Trigger runtime updates
        run: |
          pip install boto3 --quiet

          python3 << 'PYTHON_SCRIPT'
          import boto3
          import os
          import json

          REGION = os.environ.get("AWS_REGION", "us-east-2")
          NAME_PREFIX = "faiston-one"

          # List of all agents (NOTE: "data_import" renamed from "import" - Python reserved word)
          AGENTS = [
              "learning", "validation", "schema_evolution", "nexo_import",
              "intake", "data_import", "estoque_control", "compliance",
              "reconciliacao", "expedition", "carrier", "reverse",
              "observation", "equipment_research"
          ]

          client = boto3.client("bedrock-agentcore-control", region_name=REGION)

          print("=== Checking AgentCore Runtime Status ===")
          print()

          # Get list of runtimes
          try:
              response = client.list_agent_runtimes()
              runtimes = {r["agentRuntimeName"]: r for r in response.get("agentRuntimes", [])}

              for agent in AGENTS:
                  runtime_name = f"{NAME_PREFIX}-sga-{agent}"

                  if runtime_name in runtimes:
                      runtime = runtimes[runtime_name]
                      status = runtime.get("status", "UNKNOWN")
                      runtime_id = runtime.get("agentRuntimeId", "")
                      print(f"âœ… {agent}: {status} (ID: {runtime_id})")
                  else:
                      print(f"âš ï¸  {agent}: NOT FOUND (needs Terraform apply)")

          except Exception as e:
              print(f"ERROR: {e}")
              # Not a fatal error - Terraform will create runtimes
              print("Note: Runtimes may need to be created via 'terraform apply'")
          PYTHON_SCRIPT

      - name: Summary
        run: |
          echo "## SGA Agents Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Agents (14)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | Description | S3 Key |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| learning | Episodic memory | agentcore/agents/learning/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| validation | Schema validation | agentcore/agents/validation/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| schema_evolution | Dynamic schema | agentcore/agents/schema_evolution/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo_import | Orchestrator | agentcore/agents/nexo_import/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| intake | NF reader | agentcore/agents/intake/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| data_import | Bulk import | agentcore/agents/data_import/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| estoque_control | Stock control | agentcore/agents/estoque_control/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| compliance | Policy validation | agentcore/agents/compliance/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| reconciliacao | Inventory counting | agentcore/agents/reconciliacao/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| expedition | Outbound shipments | agentcore/agents/expedition/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| carrier | Shipping quotes | agentcore/agents/carrier/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| reverse | Returns | agentcore/agents/reverse/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| observation | Import analysis | agentcore/agents/observation/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| equipment_research | Doc discovery | agentcore/agents/equipment_research/agent.zip |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architecture (TRUE Multi-Agent A2A)" >> $GITHUB_STEP_SUMMARY
          echo "- **Framework:** AWS Strands Agents (A2AServer)" >> $GITHUB_STEP_SUMMARY
          echo "- **Protocol:** A2A (JSON-RPC 2.0, port 9000, root path /)" >> $GITHUB_STEP_SUMMARY
          echo "- **Entry Point:** agents/<agent_id>/main.py (per-agent A2AServer)" >> $GITHUB_STEP_SUMMARY
          echo "- **Pattern:** ORCHESTRATOR (nexo_import) + SPECIALISTS + SUPPORT" >> $GITHUB_STEP_SUMMARY
          echo "- **Communication:** Inter-agent A2A via shared/a2a_client.py" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run \`terraform plan\` to verify runtime configuration" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`terraform apply\` to create/update runtimes" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify agent health via A2A protocol: \`curl https://<runtime-url>/.well-known/agent-card.json\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 4: Status Check
  # ===========================================================================
  status:
    name: Check Runtime Status
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'status' }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check all runtimes
        run: |
          pip install boto3 --quiet

          python3 << 'PYTHON_SCRIPT'
          import boto3

          REGION = "us-east-2"
          NAME_PREFIX = "faiston-one"

          client = boto3.client("bedrock-agentcore-control", region_name=REGION)

          print("=" * 60)
          print("SGA AgentCore Runtime Status")
          print("=" * 60)
          print()

          try:
              response = client.list_agent_runtimes()

              sga_runtimes = [
                  r for r in response.get("agentRuntimes", [])
                  if r["agentRuntimeName"].startswith(f"{NAME_PREFIX}-sga-")
              ]

              if not sga_runtimes:
                  print("No SGA runtimes found. Run 'terraform apply' first.")
              else:
                  for runtime in sorted(sga_runtimes, key=lambda x: x["agentRuntimeName"]):
                      name = runtime["agentRuntimeName"]
                      status = runtime.get("status", "UNKNOWN")
                      runtime_id = runtime.get("agentRuntimeId", "")

                      # Extract agent name
                      agent = name.replace(f"{NAME_PREFIX}-sga-", "")

                      emoji = "âœ…" if status == "ACTIVE" else "âš ï¸" if status == "CREATING" else "âŒ"
                      print(f"{emoji} {agent:25} | {status:10} | {runtime_id}")

          except Exception as e:
              print(f"ERROR: {e}")
          PYTHON_SCRIPT
