# E2E Smart Import Test Progress
# Ralph Wiggum Loop - Iteration Tracker

## Current Task
Import 1,688 expedition records via A2A protocol (E2E Smart Import test)

## Success Criteria
- [ ] E2E test script runs without HTTP errors
- [ ] NEXO agent processes file analysis request
- [ ] Import executes successfully
- [ ] 1,688 records in pending_entry_items table

## Iterations

### Iteration 1 (2026-01-12)
- Ran E2E test with old URL format (/?qualifier=DEFAULT)
- Result: HTTP 404 (UnknownOperationException)
- Fix: Changed URL to /invocations/ path

### Iteration 2 (2026-01-12)
- Ran E2E test with correct URL format (/invocations/)
- Result: HTTP 424 (Runtime client error -32055)
- Diagnosis: Need to check CloudWatch logs

### Iteration 3 (2026-01-12)
- Checked CloudWatch logs for nexo_import runtime
- Root cause found: ImportError: cannot import name 'genai' from 'google'
- Analysis: CI workflow installs strands-agents[a2a] without gemini extra
- Fix: Updated deploy-agentcore-sga-agents.yml to use strands-agents[a2a,gemini]
- Status: FIXED - Deployed via GitHub Actions

### Iteration 4 (2026-01-12)
- Updated SSM parameter with real Google API key (AIzaSy...)
- Forced runtime update via AWS CLI (version 31)
- Ran E2E test - got Internal error (-32603)
- Checked CloudWatch logs - found model not found error:
  `models/gemini-3.0-pro is not found for API version v1beta`
- Root cause: BUG-006 - Invalid model names
  - Code uses: gemini-3.0-pro, gemini-3.0-flash
  - Correct: gemini-3-pro-preview, gemini-3-flash-preview
- Fix: Updated server/agentcore-inventory/agents/utils.py
- Status: PENDING - Need to commit, deploy, and re-test

### Iteration 5 (2026-01-12)
- Deployed BUG-006 fix, forced runtime update to v33
- Ran E2E test - got Internal error (-32603)
- Checked CloudWatch logs - found new error:
  `Function call is missing a thought_signature in functionCall parts`
- Root cause: BUG-007 - Strands SDK doesn't support Gemini 3 thoughtSignature
  - Gemini 3 preview models require thoughtSignature for multi-step function calling
  - Strands SDK 1.21.0 doesn't forward this signature back
  - Issue: https://github.com/strands-agents/sdk-python/issues/1199
- User decision: Use Gemini 2.5 Pro as temporary workaround
- Fix: Updated utils.py to use gemini-2.5-pro and gemini-2.5-flash
- Status: FIXED - Deployed via GitHub Actions

### Iteration 6 (2026-01-12)
- Deployed BUG-007 workaround (Gemini 2.5), forced runtime update to v35
- Ran E2E test - got HTTP 424 (Runtime initialization time exceeded)
- CloudWatch shows server starts successfully (<1 second)
- But AgentCore's health check handshake times out (5-10s window)
- Root cause: BUG-008 - Blocking GeminiModel initialization
  - GeminiModel constructor makes HTTP call to Google API (generativelanguage.googleapis.com)
  - This blocks A2A server startup, preventing health check response
  - Observation agent works (warm session), nexo_import fails (cold start blocks)
- Fix: Implemented LazyGeminiModel wrapper in utils.py
  - Defers Google API connection until first actual inference request
  - A2A server starts instantly, responds to health checks
  - Model initializes on first real user request
- Status: FIXED - 424 timeout resolved

### Iteration 7 (2026-01-12)
- Deployed BUG-008 fix (LazyGeminiModel), forced runtime update to v37
- Ran E2E test - got Internal error (-32603)
- CloudWatch shows:
  - ✅ LazyGeminiModel deferred init correctly
  - ✅ Server started instantly (no 424)
  - ❌ Gemini API error: "Thinking level is not supported for this model."
- INCORRECT diagnosis: Thought Gemini 2.5 doesn't support thinking
- INCORRECT fix: Disabled thinking for Gemini 2.5 (WRONG!)
- Status: FIX WAS INCORRECT - See Iteration 8

### Iteration 8 (2026-01-12)
- User correction: Gemini 2.5 DOES support thinking mode!
- The difference is the PARAMETER NAME, not capability:
  - Gemini 3: uses `thinking_level` ("high", "medium", "low")
  - Gemini 2.5: uses `thinking_budget` (128-32768, or -1 for dynamic)
- Reference: https://ai.google.dev/gemini-api/docs/thinking
- Root cause: BUG-009 was WRONG PARAMETER NAME, not missing support
- Correct fix: Use `thinking_budget: -1` for Gemini 2.5 (dynamic allocation)
- Status: DEPLOYING - Committing correct fix

## Bug Fixes Applied This Session
1. BUG-004: Missing AgentCore runtime endpoints (FIXED - Terraform import)
2. BUG-005: Missing google-genai dependency (FIXED - CI workflow update)
3. BUG-006: Invalid Gemini model names (FIXED - utils.py updated)
4. BUG-007: Strands SDK thoughtSignature incompatibility (WORKAROUND - Gemini 2.5)
5. BUG-008: Blocking GeminiModel initialization (FIXED - LazyGeminiModel wrapper)
6. BUG-009: Wrong thinking parameter for Gemini 2.5 (FIXED - use thinking_budget:-1)

## Next Steps
1. Commit BUG-008 fix (LazyGeminiModel)
2. Push to trigger GitHub Actions
3. Wait for deployment to complete
4. Force runtime update
5. Re-run E2E test
6. Verify 1,688 records imported
